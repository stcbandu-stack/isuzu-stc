---
import MainLayout from '../../layouts/MainLayout.astro';
import { createClient } from '@supabase/supabase-js';

// Check authentication
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
const supabase = createClient(supabaseUrl, supabaseAnonKey);

const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

if (!accessToken || !refreshToken) {
  return Astro.redirect('/team/login?redirect=/team/stock-summary');
}

// Try to set session, refresh if needed
let user = null;
const { data: sessionData, error } = await supabase.auth.setSession({
  access_token: accessToken,
  refresh_token: refreshToken,
});

if (error) {
  const { data: refreshData, error: refreshError } = await supabase.auth.refreshSession({
    refresh_token: refreshToken,
  });
  
  if (refreshError || !refreshData?.session) {
    Astro.cookies.delete('sb-access-token', { path: '/' });
    Astro.cookies.delete('sb-refresh-token', { path: '/' });
    return Astro.redirect('/team/login?redirect=/team/stock-summary');
  }
  
  Astro.cookies.set('sb-access-token', refreshData.session.access_token, {
    path: '/',
    httpOnly: true,
    secure: true,
    sameSite: 'lax',
    maxAge: 60 * 60 * 24 * 7,
  });
  Astro.cookies.set('sb-refresh-token', refreshData.session.refresh_token, {
    path: '/',
    httpOnly: true,
    secure: true,
    sameSite: 'lax',
    maxAge: 60 * 60 * 24 * 7,
  });
  
  user = refreshData.session.user;
} else {
  user = sessionData?.user;
}

if (!user) {
  return Astro.redirect('/team/login?redirect=/team/stock-summary');
}
---

<MainLayout title="‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏£‡∏ñ‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á | Team Dashboard">
  <style is:global>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700;800&display=swap');
    
    body {
      font-family: 'Sarabun', sans-serif;
    }
    
    /* Modern Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(99, 102, 241, 0.1);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #6366f1, #8b5cf6);
      border-radius: 10px;
    }

    /* Stats Card Animation */
    .stat-card {
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
    }

    /* Tab Styles */
    .tab-btn {
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.7);
      border: 2px solid transparent;
    }
    .tab-btn:hover {
      background: rgba(255,255,255,0.15);
      color: white;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      border-color: rgba(255,255,255,0.3);
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }
    .grid-container.hidden {
      display: none;
    }

    /* Pulse Animation */
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(99, 102, 241, 0); }
    }

    .pulse-glow {
      animation: pulse-glow 2s infinite;
    }

    /* Slow bounce for floating indicator */
    @keyframes bounce-slow {
      0%, 100% {
        transform: translateX(-50%) translateY(0);
      }
      50% {
        transform: translateX(-50%) translateY(-8px);
      }
    }

    .animate-bounce-slow {
      animation: bounce-slow 2s ease-in-out infinite;
    }

    /* Summary Grid */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    /* Custom Table Styles */
    .pivot-table {
      border-collapse: collapse;
      font-size: 14px;
      width: 100%;
    }

    .pivot-table th {
      background: linear-gradient(135deg, #1e1b4b, #312e81);
      color: white;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 11px;
      padding: 6px 2px;
      border: 1px solid rgba(255,255,255,0.2);
      white-space: nowrap;
    }

    .pivot-table td {
      padding: 2px 2px;
      border: 1px solid #e2e8f0;
      text-align: center;
    }

    .pivot-table tbody tr:nth-child(even) {
      background: #f8fafc;
    }

    .pivot-table tbody tr:hover {
      background: #e0e7ff;
    }

    /* Sticky first column (model name) */
    .pivot-table th:nth-child(1),
    .pivot-table td:nth-child(1) {
      position: sticky;
      left: 0;
      z-index: 5;
      background: #ffffff;
      min-width: 150px;
    }

    .pivot-table th:nth-child(1) {
      background: linear-gradient(135deg, #1e1b4b, #312e81);
      z-index: 15;
    }

    .pivot-table tbody tr:nth-child(even) td:nth-child(1) {
      background: #f8fafc;
    }

    .pivot-table tbody tr:hover td:nth-child(1) {
      background: #e0e7ff;
    }

    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .number-highlight {
      background-color: #fef3c7;
      color: #92400e;
      font-weight: 800;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 13px;
      display: inline-block;
      min-width: 20px;
    }

    .number-high {
      background-color: #fca5a5;
      color: #991b1b;
      font-weight: 800;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 13px;
      display: inline-block;
      min-width: 20px;
    }

    .total-badge {
      background-color: #dcfce7;
      color: #166534;
      font-weight: 900;
      border-radius: 4px;
      padding: 2px 8px;
      font-size: 14px;
      display: inline-block;
      min-width: 24px;
    }

    /* Brand section styling */
    .brand-section {
      margin-bottom: 2rem;
    }

    .brand-section-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem 0.75rem 0 0;
      color: white;
    }

    .brand-section-count {
      background: rgba(255,255,255,0.25);
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 700;
    }

    .zero-value {
      color: #9ca3af;
      font-size: 14px;
    }

    /* Model cell text */
    .model-text {
      color: #1e293b;
      font-weight: 600;
      font-size: 12px;
    }
  </style>

  <div class="min-h-screen bg-gradient-to-br from-slate-900 via-indigo-900 to-slate-800">
    <!-- Header -->
    <header class="bg-black/30 backdrop-blur-md border-b border-white/10 sticky top-0 z-50">
      <div class="container mx-auto px-4 py-4">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
          <div class="flex items-center gap-4">
            <a href="/team/dashboard" class="text-white/70 hover:text-white transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
              </svg>
            </a>
            <div class="flex items-center">
              <div class="bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-3 rounded-xl mr-3 shadow-lg">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
              </div>
              <div>
                <h1 class="text-2xl font-extrabold text-white tracking-tight">‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏£‡∏ñ‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</h1>
                <p class="text-sm text-white/60">Used Car Stock Inventory Dashboard</p>
              </div>
            </div>
          </div>
          
          <button onclick="loadData()" class="flex items-center gap-2 bg-gradient-to-r from-emerald-600 to-teal-600 text-white px-5 py-2.5 rounded-xl hover:from-emerald-700 hover:to-teal-700 transition shadow-lg font-bold transform active:scale-95">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </button>
        </div>
      </div>
    </header>
    
    <div id="loading" class="min-h-[60vh] px-4 py-6">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white/5 border border-white/10 rounded-2xl p-6 animate-pulse space-y-4">
          <div class="h-6 bg-white/15 rounded w-1/2"></div>
          <div class="grid grid-cols-2 gap-3">
            <div class="h-16 bg-white/10 rounded-xl"></div>
            <div class="h-16 bg-white/10 rounded-xl"></div>
          </div>
          <div class="space-y-2">
            <div class="h-3 bg-white/10 rounded w-3/4"></div>
            <div class="h-3 bg-white/10 rounded w-full"></div>
            <div class="h-3 bg-white/10 rounded w-5/6"></div>
            <div class="h-3 bg-white/10 rounded w-2/3"></div>
          </div>
        </div>
        <div class="bg-white/5 border border-white/10 rounded-2xl p-6 animate-pulse space-y-4 hidden lg:block">
          <div class="h-6 bg-white/15 rounded w-1/2"></div>
          <div class="grid grid-cols-2 gap-3">
            <div class="h-16 bg-white/10 rounded-xl"></div>
            <div class="h-16 bg-white/10 rounded-xl"></div>
          </div>
          <div class="space-y-2">
            <div class="h-3 bg-white/10 rounded w-3/4"></div>
            <div class="h-3 bg-white/10 rounded w-full"></div>
            <div class="h-3 bg-white/10 rounded w-5/6"></div>
            <div class="h-3 bg-white/10 rounded w-2/3"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden flex items-center justify-center min-h-[60vh] p-8">
      <div class="bg-red-500/10 border border-red-500/20 rounded-2xl p-8 max-w-md mx-auto text-center">
        <svg class="w-20 h-20 text-red-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <h3 class="text-xl font-bold text-white mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
        <p id="error-message" class="text-red-300/80 mb-4"></p>
        <button onclick="loadData()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-colors">
          ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
        </button>
      </div>
    </div>
    
    <!-- Dashboard Content -->
    <main id="dashboard-content" class="hidden container mx-auto px-4 py-6 space-y-8">
      
      <!-- Section 1: Total Summary with Brand Breakdown -->
      <section class="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10">
        <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-3">
          <div class="bg-emerald-500/20 p-2 rounded-lg">
            <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
          </div>
          ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠)
        </h2>
        <div id="brand-summary" class="summary-grid"></div>
      </section>

      <!-- Section 2: By Supplier -->
      <section class="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10">
        <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-3">
          <div class="bg-blue-500/20 p-2 rounded-lg">
            <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
          </div>
          ‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤ (Supplier)
        </h2>
        <div id="supplier-summary" class="summary-grid"></div>
      </section>

      <!-- Section 3: By Location -->
      <section class="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10">
        <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-3">
          <div class="bg-purple-500/20 p-2 rounded-lg">
            <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
          ‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î (Location)
        </h2>
        <div id="location-summary" class="summary-grid"></div>
      </section>

      <!-- Section 4: By Year -->
      <section class="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10">
        <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-3">
          <div class="bg-orange-500/20 p-2 rounded-lg">
            <svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
          </div>
          ‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏ú‡∏•‡∏¥‡∏ï (Year)
        </h2>
        <div id="year-summary" class="flex flex-wrap gap-3"></div>
      </section>

      <!-- Section 5: Pivot Tables -->
      <section class="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10">
        <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-3">
          <div class="bg-teal-500/20 p-2 rounded-lg">
            <svg class="w-6 h-6 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
            </svg>
          </div>
          ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏ñ (Pivot Table)
        </h2>
        
        <!-- Tab Buttons -->
        <div class="flex flex-wrap gap-2 mb-4 items-center justify-between">
          <div class="flex gap-2">
            <button id="tab-location" onclick="switchTab('location')" class="tab-btn active px-6 py-3 rounded-xl font-bold text-sm transition-all duration-300 flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
              </svg>
              ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î
            </button>
            <button id="tab-year" onclick="switchTab('year')" class="tab-btn px-6 py-3 rounded-xl font-bold text-sm transition-all duration-300 flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏ú‡∏•‡∏¥‡∏ï
            </button>
          </div>
          
          <!-- Capture Button -->
          <button id="capture-btn" onclick="captureTableAsImage()" class="bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white px-5 py-3 rounded-xl font-bold text-sm transition-all duration-300 flex items-center gap-2 shadow-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <span id="capture-btn-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏ï‡∏≤‡∏£‡∏≤‡∏á</span>
          </button>
        </div>
        
        <!-- Table Containers (grouped by brand) -->
        <div id="table-location-container" class="grid-container">
          <div id="tables-location"></div>
        </div>
        
        <div id="table-year-container" class="grid-container hidden">
          <div id="tables-year"></div>
        </div>
      </section>

    </main>
    

    
    <!-- Footer -->
    <footer class="bg-black/30 border-t border-white/10 py-4 mt-8">
      <div class="container mx-auto px-4 text-center text-white/40 text-sm">
        ¬© 2569 STC Used Car Stock Dashboard | Last Updated: <span id="last-updated">-</span>
      </div>
    </footer>
  </div>

  <script is:inline>
    // Brand color mapping
    const brandColors = {
      'ISUZU': { gradient: 'from-red-600 to-red-800', solid: '#c41e3a' },
      'TOYOTA': { gradient: 'from-red-500 to-red-700', solid: '#eb0a1e' },
      'HONDA': { gradient: 'from-red-700 to-red-900', solid: '#cc0000' },
      'NISSAN': { gradient: 'from-rose-600 to-rose-800', solid: '#c3002f' },
      'MAZDA': { gradient: 'from-red-800 to-red-950', solid: '#6b0707' },
      'MITSUBISHI': { gradient: 'from-red-600 to-red-800', solid: '#ed1c24' },
      'FORD': { gradient: 'from-blue-700 to-blue-900', solid: '#0a3d62' },
      'SUZUKI': { gradient: 'from-blue-600 to-blue-800', solid: '#1e40af' },
      'MG': { gradient: 'from-orange-500 to-orange-700', solid: '#f97316' },
      'BYD': { gradient: 'from-green-600 to-green-800', solid: '#16a34a' },
      'default': { gradient: 'from-gray-600 to-gray-800', solid: '#4b5563' }
    };

    const supplierColors = [
      { gradient: 'from-indigo-500 to-indigo-700', solid: '#6366f1' },
      { gradient: 'from-violet-500 to-violet-700', solid: '#8b5cf6' },
      { gradient: 'from-cyan-500 to-cyan-700', solid: '#06b6d4' },
      { gradient: 'from-emerald-500 to-emerald-700', solid: '#10b981' },
      { gradient: 'from-amber-500 to-amber-700', solid: '#f59e0b' },
    ];

    const locationColors = [
      { gradient: 'from-purple-500 to-purple-700', solid: '#a855f7', icon: 'üìç' },
      { gradient: 'from-fuchsia-500 to-fuchsia-700', solid: '#d946ef', icon: 'üè¢' },
      { gradient: 'from-pink-500 to-pink-700', solid: '#ec4899', icon: 'üè≠' },
      { gradient: 'from-rose-500 to-rose-700', solid: '#f43f5e', icon: 'üöó' },
      { gradient: 'from-teal-500 to-teal-700', solid: '#14b8a6', icon: 'üè™' },
    ];

    // Data state
    let pivotLocationData = [];
    let pivotYearData = [];
    let locationColumns = [];
    let yearColumns = [];
    let brandTotals = {}; // For sorting brands by total count

    // Main load function
    window.loadData = async function() {
      const loading = document.getElementById('loading');
      const content = document.getElementById('dashboard-content');
      const errorState = document.getElementById('error-state');
      
      loading.classList.remove('hidden');
      content.classList.add('hidden');
      errorState.classList.add('hidden');
      
      try {
        const response = await fetch('/api/sheets/stock-summary');
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to load data');
        }
        
        renderDashboard(result.summary);
        loading.classList.add('hidden');
        content.classList.remove('hidden');
        
        document.getElementById('last-updated').textContent = new Date().toLocaleString('th-TH');
        
      } catch (error) {
        console.error('Error loading data:', error);
        loading.classList.add('hidden');
        errorState.classList.remove('hidden');
        document.getElementById('error-message').textContent = error.message;
      }
    };

    function renderDashboard(summary) {
      renderBrandSummary(summary);
      renderSupplierSummary(summary);
      renderLocationSummary(summary);
      renderYearSummary(summary);
      
      // Store pivot data
      pivotLocationData = summary.pivotByLocation.data;
      pivotYearData = summary.pivotByYear.data;
      locationColumns = summary.pivotByLocation.locations;
      yearColumns = summary.pivotByYear.years;
      
      // Calculate brand totals for sorting
      brandTotals = {};
      pivotLocationData.forEach(row => {
        const brand = row.car_brand || 'UNKNOWN';
        brandTotals[brand] = (brandTotals[brand] || 0) + (row.total || 0);
      });
      
      // Render tables grouped by brand
      renderLocationTablesGrouped();
      renderYearTablesGrouped();
    }

    // Tab switching
    window.switchTab = function(tab) {
      const tabLocation = document.getElementById('tab-location');
      const tabYear = document.getElementById('tab-year');
      const tableLocationContainer = document.getElementById('table-location-container');
      const tableYearContainer = document.getElementById('table-year-container');
      
      if (tab === 'location') {
        tabLocation.classList.add('active');
        tabYear.classList.remove('active');
        tableLocationContainer.classList.remove('hidden');
        tableYearContainer.classList.add('hidden');
      } else {
        tabYear.classList.add('active');
        tabLocation.classList.remove('active');
        tableYearContainer.classList.remove('hidden');
        tableLocationContainer.classList.add('hidden');
      }
    };

    // Section 1: Brand Summary
    function renderBrandSummary(summary) {
      const container = document.getElementById('brand-summary');
      
      let html = `
        <div class="stat-card bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl p-5 text-white shadow-xl pulse-glow col-span-full md:col-span-1">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-semibold text-white/80 uppercase tracking-wide">‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
              <p class="text-5xl font-black mt-2">${summary.totalCars}</p>
              <p class="text-sm text-white/70 mt-1">‡∏Ñ‡∏±‡∏ô</p>
            </div>
            <div class="bg-white/20 p-4 rounded-xl">
              <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
              </svg>
            </div>
          </div>
        </div>
      `;
      
      const sortedBrands = Object.entries(summary.byBrand).sort((a, b) => b[1] - a[1]);
      
      sortedBrands.forEach(([brand, count]) => {
        const colorScheme = brandColors[brand.toUpperCase()] || brandColors.default;
        const percentage = ((count / summary.totalCars) * 100).toFixed(1);
        
        html += `
          <div class="stat-card bg-gradient-to-br ${colorScheme.gradient} rounded-xl p-5 text-white shadow-lg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs font-bold text-white/80 uppercase tracking-wider">${brand}</p>
                <p class="text-4xl font-black mt-1">${count}</p>
                <p class="text-xs text-white/70 mt-1">${percentage}% ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
              </div>
              <div class="text-4xl opacity-30">üöó</div>
            </div>
            <div class="mt-3 bg-white/20 rounded-full h-2">
              <div class="bg-white rounded-full h-2 transition-all duration-500" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Section 2: Supplier Summary
    function renderSupplierSummary(summary) {
      const container = document.getElementById('supplier-summary');
      const sortedSuppliers = Object.entries(summary.bySupplier).sort((a, b) => b[1] - a[1]);
      
      let html = '';
      sortedSuppliers.forEach(([supplier, count], index) => {
        const colorScheme = supplierColors[index % supplierColors.length];
        
        html += `
          <div class="stat-card bg-gradient-to-br ${colorScheme.gradient} rounded-xl p-5 text-white shadow-lg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs font-bold text-white/80 uppercase tracking-wider">Supplier</p>
                <p class="text-xl font-bold mt-1">${supplier || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
              </div>
              <div class="bg-white/20 px-4 py-2 rounded-xl">
                <p class="text-3xl font-black">${count}</p>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Section 3: Location Summary
    function renderLocationSummary(summary) {
      const container = document.getElementById('location-summary');
      const sortedLocations = Object.entries(summary.byLocation).sort((a, b) => b[1] - a[1]);
      
      let html = '';
      sortedLocations.forEach(([location, count], index) => {
        const colorScheme = locationColors[index % locationColors.length];
        
        html += `
          <div class="stat-card bg-gradient-to-br ${colorScheme.gradient} rounded-xl p-5 text-white shadow-lg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs font-bold text-white/80 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î</p>
                <p class="text-lg font-bold mt-1">${location || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
              </div>
              <div class="bg-white/20 px-4 py-2 rounded-xl flex items-center gap-2">
                <span class="text-2xl">${colorScheme.icon}</span>
                <p class="text-3xl font-black">${count}</p>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Section 4: Year Summary
    function renderYearSummary(summary) {
      const container = document.getElementById('year-summary');
      const sortedYears = Object.entries(summary.byYear).sort((a, b) => {
        const yearA = parseInt(a[0]) || 0;
        const yearB = parseInt(b[0]) || 0;
        return yearB - yearA;
      });
      
      // Calculate min and max for dynamic color scaling
      const counts = sortedYears.map(([_, count]) => count);
      const maxCount = Math.max(...counts);
      const minCount = Math.min(...counts);
      
      // Function to get color based on count (higher = darker orange, lower = lighter)
      function getYearCardStyle(count) {
        // Normalize count to 0-1 range
        const range = maxCount - minCount || 1;
        const normalized = (count - minCount) / range;
        
        // Interpolate between light (low count) and dark (high count)
        // Light: from-amber-300 to-orange-400 | Dark: from-orange-600 to-red-600
        if (normalized >= 0.8) {
          return 'from-red-500 to-red-700'; // Highest
        } else if (normalized >= 0.6) {
          return 'from-orange-500 to-red-500';
        } else if (normalized >= 0.4) {
          return 'from-orange-400 to-orange-600';
        } else if (normalized >= 0.2) {
          return 'from-amber-400 to-orange-500';
        } else {
          return 'from-amber-300 to-amber-500'; // Lowest
        }
      }
      
      let html = '';
      sortedYears.forEach(([year, count]) => {
        const gradientClass = getYearCardStyle(count);
        html += `
          <div class="stat-card bg-gradient-to-br ${gradientClass} rounded-xl px-5 py-3 text-white shadow-lg flex items-center gap-3 transition-all hover:scale-105">
            <div class="text-2xl font-black">${year || 'N/A'}</div>
            <div class="bg-white/30 px-3 py-1 rounded-full text-sm font-bold">${count} ‡∏Ñ‡∏±‡∏ô</div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Render Location Tables Grouped by Brand (sorted by total count descending)
    function renderLocationTablesGrouped() {
      const container = document.getElementById('tables-location');
      
      // Group data by brand
      const brandGroups = {};
      pivotLocationData.forEach(row => {
        const brand = row.car_brand || 'UNKNOWN';
        if (!brandGroups[brand]) {
          brandGroups[brand] = [];
        }
        brandGroups[brand].push(row);
      });
      
      // Sort brands by total count (descending)
      const sortedBrands = Object.keys(brandGroups).sort((a, b) => {
        return (brandTotals[b] || 0) - (brandTotals[a] || 0);
      });
      
      let allHtml = '';
      sortedBrands.forEach((brand, index) => {
        const rows = brandGroups[brand];
        const brandUpper = brand.toUpperCase();
        const colorScheme = brandColors[brandUpper] || brandColors.default;
        const totalCount = brandTotals[brand] || 0;
        const modelCount = rows.length;
        
        // Build header row
        let headerHtml = '<tr>';
        headerHtml += '<th style="min-width: 150px;">‡∏£‡∏∏‡πà‡∏ô</th>';
        locationColumns.forEach(col => {
          headerHtml += `<th style="min-width: 50px;">${col}</th>`;
        });
        headerHtml += '<th style="min-width: 50px; background: linear-gradient(135deg, #166534, #15803d) !important;">‡∏£‡∏ß‡∏°</th>';
        headerHtml += '</tr>';
        
        // Build body rows
        let bodyHtml = '';
        rows.forEach(row => {
          bodyHtml += '<tr>';
          bodyHtml += `<td style="text-align: left;"><span class="model-text">${row.car_model || '-'}</span></td>`;
          
          locationColumns.forEach(col => {
            const val = row[col] || 0;
            if (val === 0) {
              bodyHtml += `<td class="zero-value">-</td>`;
            } else {
              bodyHtml += `<td><span class="number-highlight">${val}</span></td>`;
            }
          });
          
          bodyHtml += `<td><span class="total-badge">${row.total || 0}</span></td>`;
          bodyHtml += '</tr>';
        });
        
        allHtml += `
          <div class="brand-section" id="brand-location-${index}">
            <div class="brand-section-header" style="background: linear-gradient(135deg, ${colorScheme.solid}, ${colorScheme.solid}dd);">
              <span class="text-xl font-black">${brand}</span>
              <span class="brand-section-count">${totalCount} ‡∏Ñ‡∏±‡∏ô</span>
              <span class="brand-section-count">${modelCount} ‡∏£‡∏∏‡πà‡∏ô</span>
            </div>
            <div class="table-wrapper bg-white rounded-b-xl shadow-lg">
              <table class="pivot-table">
                <thead>${headerHtml}</thead>
                <tbody>${bodyHtml}</tbody>
              </table>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = allHtml;
    }

    // Render Year Tables Grouped by Brand (sorted by total count descending)
    function renderYearTablesGrouped() {
      const container = document.getElementById('tables-year');
      
      // Group data by brand
      const brandGroups = {};
      pivotYearData.forEach(row => {
        const brand = row.car_brand || 'UNKNOWN';
        if (!brandGroups[brand]) {
          brandGroups[brand] = [];
        }
        brandGroups[brand].push(row);
      });
      
      // Sort brands by total count (descending)
      const sortedBrands = Object.keys(brandGroups).sort((a, b) => {
        return (brandTotals[b] || 0) - (brandTotals[a] || 0);
      });
      
      let allHtml = '';
      sortedBrands.forEach((brand, index) => {
        const rows = brandGroups[brand];
        const brandUpper = brand.toUpperCase();
        const colorScheme = brandColors[brandUpper] || brandColors.default;
        const totalCount = brandTotals[brand] || 0;
        const modelCount = rows.length;
        
        // Build header row
        let headerHtml = '<tr>';
        headerHtml += '<th style="min-width: 150px;">‡∏£‡∏∏‡πà‡∏ô</th>';
        yearColumns.forEach(col => {
          headerHtml += `<th style="min-width: 40px;">${col}</th>`;
        });
        headerHtml += '<th style="min-width: 50px; background: linear-gradient(135deg, #166534, #15803d) !important;">‡∏£‡∏ß‡∏°</th>';
        headerHtml += '</tr>';
        
        // Build body rows
        let bodyHtml = '';
        rows.forEach(row => {
          bodyHtml += '<tr>';
          bodyHtml += `<td style="text-align: left;"><span class="model-text">${row.car_model || '-'}</span></td>`;
          
          yearColumns.forEach(col => {
            const val = row[col] || 0;
            if (val === 0) {
              bodyHtml += `<td class="zero-value">-</td>`;
            } else if (val >= 10) {
              bodyHtml += `<td><span class="number-high">${val}</span></td>`;
            } else {
              bodyHtml += `<td><span class="number-highlight">${val}</span></td>`;
            }
          });
          
          bodyHtml += `<td><span class="total-badge">${row.total || 0}</span></td>`;
          bodyHtml += '</tr>';
        });
        
        allHtml += `
          <div class="brand-section" id="brand-year-${index}">
            <div class="brand-section-header" style="background: linear-gradient(135deg, ${colorScheme.solid}, ${colorScheme.solid}dd);">
              <span class="text-xl font-black">${brand}</span>
              <span class="brand-section-count">${totalCount} ‡∏Ñ‡∏±‡∏ô</span>
              <span class="brand-section-count">${modelCount} ‡∏£‡∏∏‡πà‡∏ô</span>
            </div>
            <div class="table-wrapper bg-white rounded-b-xl shadow-lg">
              <table class="pivot-table">
                <thead>${headerHtml}</thead>
                <tbody>${bodyHtml}</tbody>
              </table>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = allHtml;
    }

    // Capture table as image
    window.captureTableAsImage = async function() {
      const captureBtn = document.getElementById('capture-btn');
      const captureBtnText = document.getElementById('capture-btn-text');
      const locationContainer = document.getElementById('table-location-container');
      const yearContainer = document.getElementById('table-year-container');
      
      // Determine which table is active
      const isLocationActive = locationContainer && !locationContainer.classList.contains('hidden');
      const containerId = isLocationActive ? 'tables-location' : 'tables-year';
      const tableName = isLocationActive ? 'stock-by-location' : 'stock-by-year';
      
      try {
        // Step 1: Update button to loading state
        captureBtn.disabled = true;
        captureBtnText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...';
        
        // Wait a bit for DOM to update
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Step 2: Get container element
        const container = document.getElementById(containerId);
        if (!container) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á');
        }
        
        // Step 3: Create canvas using html2canvas
        const canvas = await html2canvas(container, {
          backgroundColor: '#1e293b',
          scale: 2, // Higher quality
          useCORS: true,
          logging: false,
        });
        
        // Step 4: Download the image
        const link = document.createElement('a');
        const timestamp = new Date().toISOString().slice(0, 10);
        link.download = `${tableName}-${timestamp}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        // Step 5: Reset button
        captureBtnText.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
        setTimeout(() => {
          captureBtnText.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
          captureBtn.disabled = false;
        }, 2000);
        
      } catch (error) {
        console.error('Error capturing table:', error);
        captureBtnText.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
        setTimeout(() => {
          captureBtnText.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
          captureBtn.disabled = false;
        }, 2000);
      }
    };

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
    });
  </script>
  
  <!-- html2canvas import from npm -->
  <script>
    import html2canvas from 'html2canvas';
    
    // Make html2canvas available globally for the inline script
    window.html2canvas = html2canvas;
  </script>
</MainLayout>
