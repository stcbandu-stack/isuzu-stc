---
import MainLayout from '../../layouts/MainLayout.astro';
---

<MainLayout title="Team Dashboard - ISUZU STC">
  <div class="min-h-screen bg-gradient-to-br from-gray-900 via-slate-900 to-gray-900">
    <!-- Header -->
    <header class="bg-gray-800/50 backdrop-blur-lg border-b border-gray-700/50 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
              </svg>
            </div>
            <div>
              <h1 class="text-xl font-bold text-white">Team Dashboard</h1>
              <p class="text-xs text-gray-400">ISUZU STC</p>
            </div>
          </div>
          
          <div class="flex items-center gap-4">
            <div id="userInfo" class="text-right hidden sm:block">
              <p class="text-sm text-gray-300" id="userEmail">Loading...</p>
              <p class="text-xs text-gray-500" id="userRole">-</p>
            </div>
            <button 
              id="logoutBtn"
              class="flex items-center gap-2 px-4 py-2 text-sm text-gray-300 hover:text-white bg-gray-700/50 hover:bg-gray-700 rounded-lg transition-all duration-200"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
              </svg>
              <span class="hidden sm:inline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Superuser Builder Button -->
      <div id="superuserActions" class="hidden mb-8">
        <a 
          href="/team/builder"
          class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-medium rounded-xl shadow-lg hover:shadow-xl transition-all duration-200"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"></path>
          </svg>
          ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Dashboard (Builder)
        </a>
      </div>

      <!-- Dashboard Boxes Container -->
      <div id="dashboardContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Loading State -->
        <div id="loadingState" class="col-span-full flex flex-col items-center justify-center py-20">
          <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
          <p class="text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Dashboard...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="col-span-full hidden">
          <div class="text-center py-20 bg-gray-800/30 rounded-2xl border border-gray-700/50">
            <div class="w-20 h-20 mx-auto bg-gray-700/50 rounded-2xl flex items-center justify-center mb-4">
              <svg class="w-10 h-10 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
              </svg>
            </div>
            <h3 class="text-xl font-semibold text-white mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π Dashboard</h3>
            <p class="text-gray-400 mb-6">Superuser ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ‡∏ú‡πà‡∏≤‡∏ô Dashboard Builder</p>
          </div>
        </div>
      </div>
    </main>
  </div>
</MainLayout>

<style is:global>
  /* Dashboard Box Styles */
  .dashboard-box {
    background: linear-gradient(135deg, rgba(55, 65, 81, 0.8), rgba(31, 41, 55, 0.9));
    border: 1px solid rgba(75, 85, 99, 0.5);
    border-radius: 1rem;
    padding: 1.5rem;
    transition: all 0.3s ease;
  }
  
  .dashboard-box:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  }
  
  .dashboard-menu-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
    text-decoration: none;
  }
  
  .dashboard-menu-item:hover {
    transform: translateX(4px);
  }
</style>

<script>
  import { supabase, signOutAndClearStorage } from '../../lib/supabase';

  // State
  let currentUser: any = null;
  let userRole: string = 'user';

  // Elements
  const userEmailEl = document.getElementById('userEmail');
  const userRoleEl = document.getElementById('userRole');
  const logoutBtn = document.getElementById('logoutBtn');
  const superuserActions = document.getElementById('superuserActions');
  const dashboardContent = document.getElementById('dashboardContent');
  const loadingState = document.getElementById('loadingState');
  const emptyState = document.getElementById('emptyState');

  // Color Palette
  const colorPalette: Record<string, { bg: string; text: string; border: string }> = {
    red: { bg: 'from-red-600 to-red-700', text: 'text-red-100', border: 'border-red-500/30' },
    orange: { bg: 'from-orange-600 to-orange-700', text: 'text-orange-100', border: 'border-orange-500/30' },
    yellow: { bg: 'from-yellow-500 to-yellow-600', text: 'text-yellow-100', border: 'border-yellow-500/30' },
    green: { bg: 'from-green-600 to-green-700', text: 'text-green-100', border: 'border-green-500/30' },
    teal: { bg: 'from-teal-600 to-teal-700', text: 'text-teal-100', border: 'border-teal-500/30' },
    blue: { bg: 'from-blue-600 to-blue-700', text: 'text-blue-100', border: 'border-blue-500/30' },
    indigo: { bg: 'from-indigo-600 to-indigo-700', text: 'text-indigo-100', border: 'border-indigo-500/30' },
    purple: { bg: 'from-purple-600 to-purple-700', text: 'text-purple-100', border: 'border-purple-500/30' },
    pink: { bg: 'from-pink-600 to-pink-700', text: 'text-pink-100', border: 'border-pink-500/30' },
    gray: { bg: 'from-gray-600 to-gray-700', text: 'text-gray-100', border: 'border-gray-500/30' },
  };

  // Initialize Auth
  async function initAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    
    if (!session) {
      window.location.href = '/team/login';
      return;
    }

    currentUser = session.user;
    
    if (userEmailEl) {
      userEmailEl.textContent = currentUser.email || 'Unknown';
    }

    // Check user role
    await checkUserRole();
    
    // Load dashboard content
    await loadDashboard();
  }

  // Check User Role
  async function checkUserRole() {
    if (!currentUser) return;

    console.log('Checking role for user:', currentUser.id, currentUser.email);

    // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Superuser (‡πÄ‡∏û‡∏¥‡πà‡∏° email ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô superuser)
    const superuserEmails = [
      'stc.bandu@gmail.com',
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° email ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    ];

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å email ‡∏Å‡πà‡∏≠‡∏ô (‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
    if (superuserEmails.includes(currentUser.email || '')) {
      userRole = 'superuser';
      console.log('User is superuser (by email whitelist)');
    } else {
      // ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å user_roles table
      try {
        const { data: roleData, error: roleError } = await supabase
          .from('user_roles')
          .select('role')
          .eq('user_id', currentUser.id)
          .single();

        console.log('user_roles result:', { roleData, roleError });

        if (roleData?.role) {
          userRole = roleData.role;
        }
      } catch (err) {
        console.log('user_roles query error:', err);
      }
    }

    console.log('Final userRole:', userRole);

    if (userRoleEl) {
      const roleLabels: Record<string, string> = {
        superuser: 'üëë Superuser',
        admin: 'üîß Admin',
        user: 'üë§ User'
      };
      userRoleEl.textContent = roleLabels[userRole] || 'üë§ User';
    }

    // Show superuser actions
    if (userRole === 'superuser' && superuserActions) {
      superuserActions.classList.remove('hidden');
    }
  }

  // Load Dashboard Content
  async function loadDashboard() {
    if (loadingState) loadingState.classList.remove('hidden');
    if (emptyState) emptyState.classList.add('hidden');

    try {
      const { data: boxes, error } = await supabase
        .from('dashboard_boxes')
        .select(`*, dashboard_menu_items (*)`)
        .eq('is_active', true)
        .order('position');

      if (loadingState) loadingState.classList.add('hidden');

      if (error) throw error;

      if (!boxes || boxes.length === 0) {
        if (emptyState) emptyState.classList.remove('hidden');
        return;
      }

      // Filter menu items based on permissions (if not superuser)
      const filteredBoxes = await filterMenuItemsByPermission(boxes);
      
      renderDashboardBoxes(filteredBoxes);
    } catch (err) {
      console.error('Error loading dashboard:', err);
      if (loadingState) loadingState.classList.add('hidden');
      if (emptyState) emptyState.classList.remove('hidden');
    }
  }

  // Filter menu items based on user permissions
  async function filterMenuItemsByPermission(boxes: any[]) {
    // Superuser sees everything
    if (userRole === 'superuser') {
      return boxes;
    }

    // Get user's permissions
    let userPermissions: string[] = [];
    try {
      const { data: perms } = await supabase
        .from('menu_item_permissions')
        .select('menu_item_id')
        .eq('user_id', currentUser.id)
        .eq('can_view', true);
      
      if (perms) {
        userPermissions = perms.map(p => p.menu_item_id);
      }
    } catch (err) {
      console.log('No permissions table or error:', err);
    }

    // Filter boxes and their menu items
    return boxes.map(box => {
      const filteredItems = (box.dashboard_menu_items || []).filter((item: any) => {
        // If visibility_mode is 'public' or not set, everyone can see
        if (!item.visibility_mode || item.visibility_mode === 'public') {
          return true;
        }
        // If 'restricted', check if user has permission
        return userPermissions.includes(item.id);
      });

      return {
        ...box,
        dashboard_menu_items: filteredItems
      };
    }).filter(box => box.dashboard_menu_items.length > 0); // Remove empty boxes
  }

  // Render Dashboard Boxes
  function renderDashboardBoxes(boxes: any[]) {
    if (!dashboardContent) return;

    const existingBoxes = dashboardContent.querySelectorAll('.dashboard-box-wrapper');
    existingBoxes.forEach(box => box.remove());

    boxes.forEach(box => {
      const boxColor = colorPalette[box.color] || colorPalette.gray;
      
      const boxEl = document.createElement('div');
      boxEl.className = 'dashboard-box-wrapper';
      boxEl.innerHTML = `
        <div class="dashboard-box">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 bg-gradient-to-br ${boxColor.bg} rounded-xl flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${box.icon || 'M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z'}"></path>
              </svg>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-white">${box.title}</h3>
              ${box.description ? `<p class="text-sm text-gray-400">${box.description}</p>` : ''}
            </div>
          </div>
          
          <div class="space-y-2">
            ${(box.dashboard_menu_items || [])
              .filter((item: any) => item.is_active)
              .sort((a: any, b: any) => a.position - b.position)
              .map((item: any) => {
                const itemColor = colorPalette[item.color] || colorPalette.blue;
                return `
                  <a 
                    href="${item.url || '#'}" 
                    ${item.open_in_new_tab ? 'target="_blank" rel="noopener noreferrer"' : ''}
                    class="dashboard-menu-item bg-gradient-to-r ${itemColor.bg} ${itemColor.text}"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.icon || 'M13 7l5 5m0 0l-5 5m5-5H6'}"></path>
                    </svg>
                    <span class="font-medium">${item.title}</span>
                    ${item.open_in_new_tab ? '<svg class="w-4 h-4 ml-auto opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>' : ''}
                  </a>
                `;
              }).join('')}
          </div>
        </div>
      `;
      
      dashboardContent.appendChild(boxEl);
    });
  }

  // Logout
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      await signOutAndClearStorage();
      window.location.href = '/team/login';
    });
  }

  // Init
  initAuth();
</script>
